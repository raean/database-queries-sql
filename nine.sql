SELECT finalResult.cid, cast(AVG(diff) as decimal(7,2)) AS avg_gap FROM (SELECT res1.cid, res1.dates, res2.dates AS dates2, Cast((days(res1.dates)-days(res2.dates)) as float) as diff FROM (SELECT DISTINCT ROW_NUMBER() OVER(PARTITION BY p.cid) AS rownumber,P.cid, cast(P.when as date) AS dates, COUNT(P.cid) AS NumofPurchases FROM yrb_purchase P GROUP BY P.cid, P.when) AS res1, (SELECT DISTINCT ROW_NUMBER() OVER(PARTITION BY p.cid) AS rownumber,P.cid, cast(P.when as date) AS dates, COUNT(P.cid) AS NumofPurchases FROM yrb_purchase P GROUP BY P.when, P.cid) AS res2 WHERE res1.cid = res2.cid AND (res1.rowNumber - res2.rowNumber) = 1) AS finalResult GROUP BY finalResult.cid

